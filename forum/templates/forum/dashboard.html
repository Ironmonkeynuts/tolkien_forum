{% extends 'base.html' %}
{% load static %}
{% load forum_extras %}

{% block title %}Dashboard | Speak, Friend and Enter{% endblock %}

{% block content %}
<div class="container py-5">
  <h1 class="mb-4">Admin & Moderator Dashboard</h1>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-4">
    {% if user.profile.user_type == "admin" %}
    <li class="nav-item">
      <a class="nav-link {% if tab == 'messages' %}active{% endif %}" href="?tab=messages">Contact Messages</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if tab == 'moderators' %}active{% endif %}" href="?tab=moderators">Moderator Applications</a>
    </li>
    {% endif %}
    <li class="nav-item">
      <a class="nav-link {% if tab == 'creators' %}active{% endif %}" href="?tab=creators">Creator Applications</a>
    </li>
  </ul>

  <!-- Search & Sort Form -->
  <form method="get" class="row g-2 align-items-end mb-4">
    <input type="hidden" name="tab" value="{{ tab }}">
    <div class="col-md-8">
      <label for="search" class="form-label">Search (username, message, reason)</label>
      <input type="text" id="search" name="search" class="form-control" value="{{ search }}">
    </div>
    <div class="col-md-2">
      <label for="sort" class="form-label">Sort by</label>
      <select name="sort" id="sort" class="form-select">
        <option value="-created_on" {% if sort == '-created_on' %}selected{% endif %}>Newest</option>
        <option value="created_on" {% if sort == 'created_on' %}selected{% endif %}>Oldest</option>
        <option value="user__username" {% if sort == 'user__username' %}selected{% endif %}>Username A-Z</option>
        <option value="-user__username" {% if sort == '-user__username' %}selected{% endif %}>Username Z-A</option>
        <option value="approved" {% if sort == 'approved' %}selected{% endif %}>Approved</option>
        <option value="-approved" {% if sort == '-approved' %}selected{% endif %}>Disapproved</option>
        <option value="reviewed" {% if sort == 'reviewed' %}selected{% endif %}>Reviewed</option>
        <option value="-reviewed" {% if sort == '-reviewed' %}selected{% endif %}>Unreviewed</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
  </form>

  <!-- Results Table -->
  {% if page_obj %}
    <div class="table-responsive">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            {% if tab == 'messages' %}
              <th style="width: 25%;">Email</th><th style="width: 50%;">Message</th><th style="width: 25%;">Received</th>
            {% else %}
              <th style="width: 25%;">Username</th><th style="width: 45%;">Reason</th><th style="width: 10%;">Reviewed</th><th style="width: 10%;">Approved</th><th style="width:10%;">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for item in page_obj %}
            <tr>
              {% if tab == 'messages' %}
                <td>{{ item.email }}</td>
                <td>{{ item.message|truncatechars:80 }}</td>
                <td>{{ item.created_on|date:"M d, Y" }}</td>
              {% else %}
                <td>{{ item.user.username }}</td>
                <td>{{ item.reason|truncatechars:80 }}</td>
                <td>
                  {% if item.reviewed %}
                    <span class="badge bg-success">Reviewed</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% endif %}
                </td>
                <td>
                  {% if item.approved %}
                    <span class="badge bg-primary">Approved</span>
                  {% else %}
                    <span class="badge bg-danger">Disapproved</span>
                  {% endif %}
                </td>
                <td>
                  <form method="post" action="{% url 'toggle_approval' %}">
                    {% csrf_token %}
                    <input type="hidden" name="object_type" value="{{ item|model_name }}">
                    <input type="hidden" name="object_id" value="{{ item.id }}">
                    <button type="submit" name="approval_toggle" class="btn btn-sm {% if item.approved %}btn-danger{% else %}btn-success{% endif %}">
                      {% if item.approved %}Disapprove{% else %}Approve{% endif %}
                    </button>
                  </form>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <nav aria-label="Pagination" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?tab={{ tab }}&search={{ search }}&sort={{ sort }}&page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
            <li class="page-item"><a class="page-link" href="?tab={{ tab }}&search={{ search }}&sort={{ sort }}&page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?tab={{ tab }}&search={{ search }}&sort={{ sort }}&page={{ page_obj.next_page_number }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  {% else %}
    <p class="text-muted">No data available for this tab.</p>
  {% endif %}
</div>
{% endblock %}
